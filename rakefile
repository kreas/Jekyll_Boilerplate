namespace :create do
  desc "Creates a blog post"
  task :post, :title, :category, :template do |t, args|
    if args[:title]
      title = args[:title]
      category = args[:category] || '.'
      template = args[:template] || "default"

      unless File.directory?("#{category}/_posts")
        Dir.mkdir(category)
        Dir.mkdir("#{category}/_posts")
      end


      TEMPLATE = "_templates/template.haml"
      TARGET_DIR = "#{category}/_posts"

      filename = title.gsub(' ','-')
      filename = "#{ Time.now.strftime('%Y-%m-%d') }-#{filename}.haml"
      filepath = File.join(TARGET_DIR, filename)

      new_post = File.read(TEMPLATE)
      new_post.gsub!('TITLE', title);

      new_post_file = File.open(filepath, 'w')
      new_post_file.puts new_post
      new_post_file.close

      puts "created => #{filepath}"
    else
      puts "You must specify a title. example: rake create:post title=\"Awesome Post\""
    end
  end

  desc "Creates a new page."
  task :page, :title, :filename, :template do |t, args|
    if args[:title]
      title = args[:title]
      tempalte = args[:template] || "default"

      TEMPLATE = "_templates/template.haml"

      filename = args[:filename] || title.gsub(' ', '-')
      filename = "#{filename}.haml"
      filepath = File.join('./', filename)

      new_page = File.read(TEMPLATE)
      new_page.gsub!('TITLE', title)

      new_page_file = File.open(filepath, 'w')
      new_page_file.puts new_page
      new_page_file.close

      puts "created => #{filepath}"
    else
      puts "You must specify a title. example: rake create:page title=\"Awesome Page\""
    end
  end

end


namespace :site do
  desc "Generates the site"
  task :generate do
    system 'jekyll'
  end

  desc "Starts a webserver on port 8080 and launches Safari"
  task :launch do
    fork do #Mac only
      sleep 1.5
      system 'open -a Safari http://127.0.0.1:8080'
    end
    system 'jekyll --server 8080'
    puts 'Here then, as I lay down the pen and proceed to seal up my confession, I bring the life of that unhappy Henry Jekyll to an end.'
  end

  desc "Clears the _site directory"
  task :clear do
    system 'rm -rf _site/*'
    puts 'I just deleted everything you ever loved.'
  end

  desc "Deploys the site to heroku"
  task :deploy do
    system 'git push heroku master'
  end
end
